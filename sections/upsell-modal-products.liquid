{%- liquid
  assign main_variant = product.selected_or_first_available_variant
  assign main_image = main_variant.featured_media | default: product.featured_media
-%}

<upsell-modal-content-component class="upsell-content">
  <template ref="moneyFormat">{{ shop.money_format }}</template>
  <div class="upsell-content__header">
    <h2 class="upsell-content__heading">{{ 'upsell_modal.heading' | t }}</h2>
    <button
      class="button button-unstyled upsell-content__close"
      aria-label="{{ 'accessibility.close_dialog' | t }}"
      type="button"
    >
      {{- 'icon-close.svg' | inline_asset_content -}}
    </button>
  </div>
  <div class="upsell-products">
    <div class="upsell-product-card upsell-product-card--main"
         data-variant-id="{{ main_variant.id }}"
         data-price="{{ main_variant.price }}"
         data-product-image="{{ main_image | image_url: width: 300 }}"
         data-selected="true">
      <div class="upsell-product-card__checkbox">
        <input type="checkbox" checked disabled>
      </div>
      <div class="upsell-product-card__image">
        {%- if main_image -%}
          {{-
            main_image
            | image_url: width: 300
            | image_tag:
              widths: '80, 160, 240, 300',
              sizes: '80px',
              alt: product.title,
              loading: 'lazy',
              class: 'upsell-product-card__img'
          -}}
        {%- else -%}
          {{- 'product-1' | placeholder_svg_tag: 'upsell-product-card__img upsell-product-card__img--placeholder' -}}
        {%- endif -%}
      </div>
      <div class="upsell-product-card__details">
        <h3 class="upsell-product-card__title">{{ product.title }}</h3>
        {%- if product.variants.size > 1 -%}
          <div class="upsell-variant-selectors">
            {%- for option in product.options_with_values -%}
              <select class="upsell-variant-selector" data-option-position="{{ forloop.index }}">
                {%- for value in option.values -%}
                  <option value="{{ value }}" {% if option.selected_value == value %}selected{% endif %}>
                    {{ value }}
                  </option>
                {%- endfor -%}
              </select>
            {%- endfor -%}
          </div>
        {%- endif -%}
        {%- if main_variant.sku != blank -%}
          <p class="upsell-product-card__sku">{{ 'products.product.sku_label' | t: sku: main_variant.sku }}</p>
        {%- endif -%}
        <p class="upsell-product-card__price">{{ main_variant.price | money }}</p>
        <span class="upsell-product-card__badge upsell-product-card__badge--soldout" style="display: none;">{{ 'products.product.sold_out' | t }}</span>
      </div>
      {%- if product.variants.size > 1 -%}
        <script type="application/json">
          {{ product.variants | json }}
        </script>
      {%- endif -%}
    </div>

    {%- if product.metafields.custom.upsell -%}
      {%- for upsell_product in product.metafields.custom.upsell.value -%}
        {%- liquid
          assign upsell_variant = upsell_product.selected_or_first_available_variant
          assign upsell_image = upsell_variant.featured_media | default: upsell_product.featured_media
          assign is_available = upsell_variant.available
        -%}
        <div class="upsell-product-card{% unless is_available %} upsell-product-card--unavailable{% endunless %}"
             data-variant-id="{{ upsell_variant.id }}"
             data-price="{{ upsell_variant.price }}"
             data-product-image="{{ upsell_image | image_url: width: 300 }}"
             data-selected="false">
          <div class="upsell-product-card__checkbox">
            <input type="checkbox"{% unless is_available %} disabled{% endunless %}>
          </div>
          <div class="upsell-product-card__image">
            {%- if upsell_image -%}
              {{-
                upsell_image
                | image_url: width: 300
                | image_tag:
                  widths: '80, 160, 240, 300',
                  sizes: '80px',
                  alt: upsell_product.title,
                  loading: 'lazy',
                  class: 'upsell-product-card__img'
              -}}
            {%- else -%}
              {{- 'product-1' | placeholder_svg_tag: 'upsell-product-card__img upsell-product-card__img--placeholder' -}}
            {%- endif -%}
          </div>
          <div class="upsell-product-card__details">
            <h3 class="upsell-product-card__title">{{ upsell_product.title }}</h3>
            {%- if upsell_product.variants.size > 1 -%}
              <div class="upsell-variant-selectors">
                {%- for option in upsell_product.options_with_values -%}
                  <select class="upsell-variant-selector" data-option-position="{{ forloop.index }}">
                    {%- for value in option.values -%}
                      <option value="{{ value }}" {% if option.selected_value == value %}selected{% endif %}>
                        {{ value }}
                      </option>
                    {%- endfor -%}
                  </select>
                {%- endfor -%}
              </div>
            {%- endif -%}
            {%- if upsell_variant.sku != blank -%}
              <p class="upsell-product-card__sku">{{ 'products.product.sku_label' | t: sku: upsell_variant.sku }}</p>
            {%- endif -%}
            <p class="upsell-product-card__price">{{ upsell_variant.price | money }}</p>
            <span class="upsell-product-card__badge upsell-product-card__badge--soldout" {% if is_available %}style="display: none;"{% endif %}>{{ 'products.product.sold_out' | t }}</span>
          </div>
          {%- if upsell_product.variants.size > 1 -%}
            <script type="application/json">
              {{ upsell_product.variants | json }}
            </script>
          {%- endif -%}
        </div>
      {%- endfor -%}
    {%- endif -%}
  </div>

  <div class="upsell-footer">
    <div class="upsell-footer__subtotal">
      <span class="upsell-footer__subtotal-label">{{ 'content.cart_subtotal' | t }}</span>
      <span class="upsell-footer__subtotal-amount">{{ main_variant.price | money }}</span>
    </div>
    <button type="button" class="button upsell-footer__confirm">
      <span class="add-to-cart-text">
        <span class="add-to-cart-text__content">
          {{ 'upsell_modal.confirm' | t }}
        </span>
      </span>
      <span aria-hidden="true" class="add-to-cart-text--added">
        <span class="svg-wrapper add-to-cart-icon--added">
          {{- 'icon-checkmark.svg' | inline_asset_content -}}
        </span>
        <span>
          {{- 'actions.added' | t -}}
        </span>
      </span>
    </button>
  </div>
</upsell-modal-content-component>
